<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auto Repair Shop P&L Projections - Dynamic Bay Scaling</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.95;
        }

        .controls {
            background: #f8f9fa;
            padding: 20px 30px;
            border-bottom: 2px solid #e9ecef;
        }

        .control-row {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            align-items: center;
            margin-bottom: 15px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .control-group label {
            font-size: 0.85em;
            color: #6c757d;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .control-group input, .control-group select {
            padding: 8px 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s ease;
            background: white;
        }

        .control-group input:focus, .control-group select:focus {
            outline: none;
            border-color: #2a5298;
            box-shadow: 0 0 0 3px rgba(42, 82, 152, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(42, 82, 152, 0.4);
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            padding: 20px 30px;
            background: #e8f4f8;
            border-bottom: 2px solid #d1e7f5;
        }

        .metric-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .metric-card h4 {
            color: #6c757d;
            font-size: 0.8em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }

        .metric-card .value {
            font-size: 1.4em;
            font-weight: 700;
            color: #1e3c72;
        }

        .bay-info {
            background: #fff3cd;
            color: #856404;
            padding: 10px 15px;
            border-radius: 8px;
            margin: 15px 30px;
            border-left: 4px solid #ffc107;
        }

        .table-wrapper {
            padding: 30px;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            font-size: 0.95em;
        }

        th {
            background: #f8f9fa;
            padding: 12px 10px;
            text-align: right;
            font-weight: 600;
            color: #495057;
            position: sticky;
            top: 0;
            z-index: 10;
            border-bottom: 2px solid #dee2e6;
        }

        th:first-child {
            text-align: left;
            padding-left: 15px;
        }

        td {
            padding: 10px;
            text-align: right;
            border-bottom: 1px solid #e9ecef;
        }

        td:first-child {
            text-align: left;
            padding-left: 15px;
            font-weight: 500;
            color: #495057;
        }

        tr.category-header td {
            background: #e8f4f8;
            font-weight: 700;
            color: #1e3c72;
            padding-top: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #b8d4e8;
        }

        tr.subcategory td:first-child {
            padding-left: 35px;
            color: #6c757d;
        }

        tr.total-row td {
            background: #d4edda;
            font-weight: 700;
            color: #155724;
            border-top: 2px solid #28a745;
            border-bottom: 2px solid #28a745;
        }

        tr.expense-total td {
            background: #f8d7da;
            font-weight: 700;
            color: #721c24;
            border-top: 2px solid #dc3545;
            border-bottom: 2px solid #dc3545;
        }

        tr.net-income td {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            font-weight: 700;
            color: white;
            font-size: 1.1em;
            padding: 15px 10px;
            border: none;
        }

        .editable {
            background: #fff;
            border: 1px solid transparent;
            transition: all 0.3s ease;
            cursor: text;
            padding: 4px 8px;
            border-radius: 4px;
            width: 90px;
        }

        .editable:hover {
            background: #f8f9fa;
            border-color: #dee2e6;
        }

        .editable:focus {
            outline: none;
            background: #fff;
            border-color: #2a5298;
            box-shadow: 0 0 0 3px rgba(42, 82, 152, 0.1);
        }

        .positive {
            color: #28a745;
        }

        .negative {
            color: #dc3545;
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            padding: 30px;
            background: #f8f9fa;
        }

        .summary-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .summary-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.2);
        }

        .summary-card h3 {
            color: #6c757d;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
        }

        .summary-card .value {
            font-size: 2em;
            font-weight: 700;
            color: #212529;
        }

        .summary-card.profit .value {
            color: #28a745;
        }

        .summary-card.loss .value {
            color: #dc3545;
        }

        .efficiency-bar {
            background: #e9ecef;
            border-radius: 10px;
            height: 20px;
            overflow: hidden;
            margin-top: 5px;
        }

        .efficiency-fill {
            background: linear-gradient(90deg, #28a745, #20c997);
            height: 100%;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.8em;
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .table-wrapper {
                padding: 15px;
            }
            
            th, td {
                padding: 8px 5px;
                font-size: 0.85em;
            }
            
            .header h1 {
                font-size: 1.8em;
            }

            .editable {
                width: 70px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Auto Repair Shop P&L Projections</h1>
            <p>Dynamic Bay Scaling Model with Configurable Efficiency</p>
        </div>

        <div class="controls">
            <style>
                .config-section {
                    margin-bottom: 20px;
                    border: 1px solid #dee2e6;
                    border-radius: 8px;
                    overflow: visible;
                    position: relative;
                    z-index: 1;
                }
                .config-section-header {
                    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
                    padding: 12px 20px;
                    cursor: pointer;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    font-weight: 600;
                    color: #495057;
                    border-radius: 8px 8px 0 0;
                    position: relative;
                    z-index: 2;
                }
                .config-section-header:hover {
                    background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
                }
                .config-section-content {
                    padding: 15px 20px;
                    background: white;
                    border-radius: 0 0 8px 8px;
                    overflow: hidden;
                    max-height: 2000px;
                    transition: max-height 0.3s ease, padding 0.3s ease;
                }
                .config-section.collapsed .config-section-content {
                    max-height: 0;
                    padding-top: 0;
                    padding-bottom: 0;
                    overflow: hidden;
                }
                .config-section.collapsed .config-section-header {
                    border-radius: 8px;
                }
                .expand-icon {
                    transition: transform 0.3s;
                }
                .config-section.collapsed .expand-icon {
                    transform: rotate(-90deg);
                }
                .button-row {
                    padding: 20px;
                    background: #f8f9fa;
                    border-top: 2px solid #dee2e6;
                    display: flex;
                    gap: 10px;
                    justify-content: center;
                }
            </style>
            
            <!-- Bay & Efficiency Configuration -->
            <div class="config-section" id="baySection">
                <div class="config-section-header" onclick="toggleSection('baySection')">
                    <span>Bay & Efficiency Settings</span>
                    <span class="expand-icon">▼</span>
                </div>
                <div class="config-section-content">
                    <div class="control-row">
                        <div class="control-group">
                            <label>Starting Bays</label>
                            <input type="number" id="startingBays" value="2" min="1" max="10">
                        </div>
                        <div class="control-group">
                            <label>Maximum Bays</label>
                            <input type="number" id="maxBays" value="6" min="1" max="20">
                        </div>
                        <div class="control-group">
                            <label>Starting Efficiency (%)</label>
                            <input type="number" id="startingEfficiency" value="40" min="10" max="100">
                        </div>
                        <div class="control-group">
                            <label>Monthly Growth Rate (%)</label>
                            <input type="number" id="growthRate" value="20" min="0" max="50">
                        </div>
                    </div>
                    <div class="control-row">
                        <div class="control-group">
                            <label>Add Bay at Efficiency (%)</label>
                            <input type="number" id="bayTrigger" value="100" min="50" max="100">
                        </div>
                    </div>
                    <div class="control-row">
                        <div class="control-group">
                            <label>New Bay Reset Efficiency (%)</label>
                            <input type="number" id="newBayResetEfficiency" value="50" min="10" max="100">
                        </div>
                        <div class="control-group">
                            <label>Max Revenue/Bay at 100% ($)</label>
                            <input type="number" id="maxRevenuePerBay" value="20000" min="10000" max="50000" step="1000">
                        </div>
                        <div class="control-group">
                            <label>Detail Efficiency Multiplier</label>
                            <input type="number" id="detailEfficiencyMultiplier" value="1.2" min="1" max="2" step="0.1">
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Service Configuration -->
            <div class="config-section" id="serviceSection">
                <div class="config-section-header" onclick="toggleSection('serviceSection')">
                    <span>Service Settings</span>
                    <span class="expand-icon">▼</span>
                </div>
                <div class="config-section-content">
                    <div class="control-row">
                        <div class="control-group">
                            <label>Labor Rate ($/hr)</label>
                            <input type="number" id="laborRate" value="125" min="50" max="300">
                        </div>
                        <div class="control-group">
                            <label>Working Days/Month</label>
                            <input type="number" id="workingDays" value="21" min="15" max="30">
                        </div>
                        <div class="control-group">
                            <label>Hours per Ticket</label>
                            <input type="number" id="hoursPerTicket" value="1.6" min="0.5" max="8" step="0.1">
                        </div>
                        <div class="control-group">
                            <label>Operating Hours/Day</label>
                            <input type="number" id="operatingHoursPerDay" value="8" min="6" max="12">
                        </div>
                    </div>
                    <div class="control-row">
                        <div class="control-group">
                            <label>Cars/Day/Lift at 100%</label>
                            <input type="number" id="carsPerDayPerLift" value="5" min="1" max="10">
                        </div>
                        <div class="control-group">
                            <label>Shop Charge % of Labor</label>
                            <input type="number" id="shopChargePercent" value="7" min="0" max="15">
                        </div>
                        <div class="control-group">
                            <label>Shop Charge Cap/Order ($)</label>
                            <input type="number" id="shopChargeCap" value="60" min="0" max="200">
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Parts & Inventory Configuration -->
            <div class="config-section collapsed" id="partsSection">
                <div class="config-section-header" onclick="toggleSection('partsSection')">
                    <span>Parts & Inventory</span>
                    <span class="expand-icon">▼</span>
                </div>
                <div class="config-section-content">
                    <div class="control-row">
                        <div class="control-group">
                            <label>Parts Markup (%)</label>
                            <input type="number" id="partsMarkup" value="40" min="10" max="100">
                        </div>
                        <div class="control-group">
                            <label>Service to Parts Generation (%)</label>
                            <input type="number" id="serviceToPartsPercent" value="70" min="0" max="100">
                        </div>
                        <div class="control-group">
                            <label>Initial Tire Inventory ($)</label>
                            <input type="number" id="initialTireInventory" value="10000" min="0" max="50000" step="1000">
                        </div>
                        <div class="control-group">
                            <label>Monthly Tire Inventory ($)</label>
                            <input type="number" id="monthlyTireInventory" value="15000" min="0" max="50000" step="1000">
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Revenue Streams Configuration -->
            <div class="config-section collapsed" id="revenueSection">
                <div class="config-section-header" onclick="toggleSection('revenueSection')">
                    <span>Revenue Streams</span>
                    <span class="expand-icon">▼</span>
                </div>
                <div class="config-section-content">
                    <div class="control-row">
                        <div class="control-group">
                            <label>Detail Max Revenue at 100% ($)</label>
                            <input type="number" id="detailMaxRevenue" value="20000" min="5000" max="50000" step="1000">
                        </div>
                        <div class="control-group">
                            <label>Initial Used Cars Sold</label>
                            <input type="number" id="initialUsedCars" value="5" min="0" max="20">
                        </div>
                        <div class="control-group">
                            <label>Profit per Used Car ($)</label>
                            <input type="number" id="profitPerUsedCar" value="3000" min="500" max="10000" step="500">
                        </div>
                    </div>
                    <div class="control-row">
                        <div class="control-group">
                            <label>Used Car Growth Rate (%)</label>
                            <input type="number" id="usedCarGrowthPercent" value="15" min="0" max="50">
                        </div>
                    </div>
                    <div class="control-row">
                        <div class="control-group">
                            <label>First Month Warranties</label>
                            <input type="number" id="firstMonthWarranties" value="1" min="0" max="10">
                        </div>
                        <div class="control-group">
                            <label>Monthly Warranties After</label>
                            <input type="number" id="monthlyWarrantiesAfter" value="4" min="0" max="20">
                        </div>
                        <div class="control-group">
                            <label>Warranty Price ($)</label>
                            <input type="number" id="warrantyPrice" value="1000" min="100" max="5000" step="100">
                        </div>
                    </div>
                    <div class="control-row">
                        <div class="control-group">
                            <label>Oil Disposal Fee ($)</label>
                            <input type="number" id="oilDisposalFee" value="150" min="0" max="500">
                        </div>
                        <div class="control-group">
                            <label>General Disposal Fee ($)</label>
                            <input type="number" id="generalDisposalFee" value="200" min="0" max="500">
                        </div>
                        <div class="control-group">
                            <label>Battery Disposal Fee ($)</label>
                            <input type="number" id="batteryDisposalFee" value="825" min="0" max="2000">
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Staff Salaries Configuration -->
            <div class="config-section collapsed" id="salariesSection">
                <div class="config-section-header" onclick="toggleSection('salariesSection')">
                    <span>Staff Salaries</span>
                    <span class="expand-icon">▼</span>
                </div>
                <div class="config-section-content">
                    <div class="control-row">
                        <div class="control-group">
                            <label>Senior Tech Annual Salary ($)</label>
                            <input type="number" id="seniorTechAnnualSalary" value="60000" min="30000" max="150000" step="5000">
                        </div>
                        <div class="control-group">
                            <label>Junior Tech Annual Salary ($)</label>
                            <input type="number" id="juniorTechAnnualSalary" value="45000" min="25000" max="100000" step="5000">
                        </div>
                    </div>
                    <div class="control-row">
                        <div class="control-group">
                            <label>Service Advisor Annual Salary ($)</label>
                            <input type="number" id="serviceAdvisorAnnualSalary" value="70000" min="30000" max="150000" step="5000">
                        </div>
                        <div class="control-group">
                            <label>Manager Annual Salary ($)</label>
                            <input type="number" id="managerAnnualSalary" value="100000" min="50000" max="200000" step="5000">
                        </div>
                        <div class="control-group">
                            <label>Manager Annual Bonus ($)</label>
                            <input type="number" id="managerAnnualBonus" value="10000" min="0" max="50000" step="1000">
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Operating Expenses Configuration -->
            <div class="config-section collapsed" id="expensesSection">
                <div class="config-section-header" onclick="toggleSection('expensesSection')">
                    <span>Operating Expenses</span>
                    <span class="expand-icon">▼</span>
                </div>
                <div class="config-section-content">
                    <div class="control-row">
                        <div class="control-group">
                            <label>Monthly Advertising ($)</label>
                            <input type="number" id="monthlyAdvertising" value="1500" min="0" max="10000" step="100">
                        </div>
                        <div class="control-group">
                            <label>ShopKey Software Monthly ($)</label>
                            <input type="number" id="shopKeySoftwareMonthly" value="300" min="0" max="1000">
                        </div>
                        <div class="control-group">
                            <label>Payment Processing %</label>
                            <input type="number" id="paymentProcessingPercent" value="2.29" min="0" max="5" step="0.01">
                        </div>
                        <div class="control-group">
                            <label>Processing per Transaction ($)</label>
                            <input type="number" id="paymentProcessingPerTransaction" value="0.09" min="0" max="1" step="0.01">
                        </div>
                    </div>
                    <div class="control-row">
                        <div class="control-group">
                            <label>AAA Annual Membership ($)</label>
                            <input type="number" id="aaaAnnualMembership" value="400" min="0" max="2000">
                        </div>
                        <div class="control-group">
                            <label>Monthly Fuel Card ($)</label>
                            <input type="number" id="monthlyFuelCard" value="400" min="0" max="2000">
                        </div>
                        <div class="control-group">
                            <label>Monthly Utilities ($)</label>
                            <input type="number" id="monthlyUtilities" value="1200" min="0" max="5000" step="100">
                        </div>
                    </div>
                    <div class="control-row">
                        <div class="control-group">
                            <label>Monthly Surety Bond ($)</label>
                            <input type="number" id="monthlySuretyBond" value="20" min="0" max="500">
                        </div>
                        <div class="control-group">
                            <label>Monthly General Liability ($)</label>
                            <input type="number" id="monthlyGeneralLiability" value="200" min="0" max="2000">
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Equipment & Supplies Configuration -->
            <div class="config-section collapsed" id="equipmentSection">
                <div class="config-section-header" onclick="toggleSection('equipmentSection')">
                    <span>Equipment & Supplies</span>
                    <span class="expand-icon">▼</span>
                </div>
                <div class="config-section-content">
                    <div class="control-row">
                        <div class="control-group">
                            <label>Laptop Cost Each ($)</label>
                            <input type="number" id="laptopCostEach" value="1500" min="0" max="5000" step="100">
                        </div>
                        <div class="control-group">
                            <label>Desktop Cost Each ($)</label>
                            <input type="number" id="desktopCostEach" value="2000" min="0" max="5000" step="100">
                        </div>
                        <div class="control-group">
                            <label>Number of Desktops</label>
                            <input type="number" id="numberOfDesktops" value="2" min="0" max="10">
                        </div>
                        <div class="control-group">
                            <label>Scan Tool Cost ($)</label>
                            <input type="number" id="scanToolCost" value="2500" min="0" max="10000" step="100">
                        </div>
                    </div>
                    <div class="control-row">
                        <div class="control-group">
                            <label>Monthly Detail Supplies ($)</label>
                            <input type="number" id="monthlyDetailSupplies" value="500" min="0" max="2000">
                        </div>
                        <div class="control-group">
                            <label>Monthly Shop Supplies ($)</label>
                            <input type="number" id="monthlyShopSupplies" value="1000" min="0" max="5000" step="100">
                        </div>
                        <div class="control-group">
                            <label>Monthly Oil Cost per Lift ($)</label>
                            <input type="number" id="monthlyOilCostPerLift" value="2500" min="0" max="5000" step="100">
                        </div>
                    </div>
                    <div class="control-row">
                        <div class="control-group">
                            <label>Waste Oil Filters Cost ($)</label>
                            <input type="number" id="wasteOilFiltersCost" value="300" min="0" max="1000">
                        </div>
                        <div class="control-group">
                            <label>Coolant Disposal Cost ($)</label>
                            <input type="number" id="coolantDisposalCost" value="300" min="0" max="1000">
                        </div>
                        <div class="control-group">
                            <label>Waste Disposal Frequency (Months)</label>
                            <input type="number" id="wasteDisposalFrequencyMonths" value="6" min="1" max="12">
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Calculation Rules & Formulas Configuration -->
            <div class="config-section collapsed" id="calculationSection">
                <div class="config-section-header" onclick="toggleSection('calculationSection')">
                    <span>Calculation Rules & Formulas</span>
                    <span class="expand-icon">▼</span>
                </div>
                <div class="config-section-content">
                    <h4 style="color: #495057; margin-bottom: 15px; border-bottom: 1px solid #dee2e6; padding-bottom: 5px;">Revenue Calculations</h4>
                    <div class="control-row">
                        <div class="control-group">
                            <label>Parts Generation Formula</label>
                            <select id="partsGenerationFormula">
                                <option value="percentOfService" selected>% of Service Revenue</option>
                                <option value="fixedAmount">Fixed Amount</option>
                                <option value="perWorkOrder">Per Work Order</option>
                            </select>
                        </div>
                        <div class="control-group">
                            <label>Parts Generation Modifier</label>
                            <input type="number" id="partsGenerationModifier" value="1.0" min="0" max="5" step="0.1">
                        </div>
                        <div class="control-group">
                            <label>Shop Charge Formula</label>
                            <select id="shopChargeFormula">
                                <option value="minOfPercentOrCap" selected>Min of % or Cap</option>
                                <option value="percentOnly">Percentage Only</option>
                                <option value="perOrderOnly">Per Order Only</option>
                            </select>
                        </div>
                    </div>
                    <div class="control-row">
                        <div class="control-group">
                            <label>Work Order Calculation</label>
                            <select id="workOrderFormula">
                                <option value="revenuePerTicket" selected>Revenue ÷ Ticket Value</option>
                                <option value="carsTimesEfficiency">Cars × Efficiency</option>
                                <option value="fixed">Fixed Amount</option>
                            </select>
                        </div>
                        <div class="control-group">
                            <label>Fixed Work Orders (if Fixed)</label>
                            <input type="number" id="workOrdersFixed" value="100" min="0" max="500">
                        </div>
                    </div>
                    
                    <h4 style="color: #495057; margin: 15px 0; border-bottom: 1px solid #dee2e6; padding-bottom: 5px;">Cost Calculations</h4>
                    <div class="control-row">
                        <div class="control-group">
                            <label>Tech Salary Formula</label>
                            <select id="techSalaryFormula">
                                <option value="seniorPlusJuniors" selected>Senior + Juniors</option>
                                <option value="allEqual">All Equal Salaries</option>
                                <option value="perBay">Fixed per Bay</option>
                            </select>
                        </div>
                        <div class="control-group">
                            <label>Tech Salary per Bay (Annual)</label>
                            <input type="number" id="techSalaryPerBay" value="50000" min="20000" max="150000" step="5000">
                        </div>
                    </div>
                    <div class="control-row">
                        <div class="control-group">
                            <label>Oil Cost Formula</label>
                            <select id="oilCostFormula">
                                <option value="perBay" selected>Per Bay/Lift</option>
                                <option value="percentOfRevenue">% of Service Revenue</option>
                                <option value="perWorkOrder">Per Work Order</option>
                            </select>
                        </div>
                        <div class="control-group">
                            <label>Oil Cost % (if % of Revenue)</label>
                            <input type="number" id="oilCostPercent" value="5" min="0" max="20" step="0.5">
                        </div>
                        <div class="control-group">
                            <label>Oil Cost per Order (if per WO)</label>
                            <input type="number" id="oilCostPerOrder" value="50" min="0" max="200" step="10">
                        </div>
                    </div>
                    <div class="control-row">
                        <div class="control-group">
                            <label>Payment Processing Formula</label>
                            <select id="paymentProcessFormula">
                                <option value="percentPlusTransaction" selected>% + Per Transaction</option>
                                <option value="percentOnly">Percentage Only</option>
                                <option value="flatRate">Flat Monthly Rate</option>
                            </select>
                        </div>
                        <div class="control-group">
                            <label>Flat Rate (if Flat)</label>
                            <input type="number" id="paymentProcessFlatRate" value="1000" min="0" max="5000" step="100">
                        </div>
                    </div>
                    
                    <h4 style="color: #495057; margin: 15px 0; border-bottom: 1px solid #dee2e6; padding-bottom: 5px;">Efficiency Calculations</h4>
                    <div class="control-row">
                        <div class="control-group">
                            <label>Detail Efficiency Link</label>
                            <select id="detailEfficiencyLink">
                                <option value="serviceEfficiency" selected>Linked to Service</option>
                                <option value="independent">Independent</option>
                                <option value="fixed">Fixed Value</option>
                            </select>
                        </div>
                        <div class="control-group">
                            <label>Detail Efficiency Formula</label>
                            <select id="detailEfficiencyFormula">
                                <option value="multiplier" selected>Multiplier</option>
                                <option value="addition">Addition</option>
                                <option value="direct">Direct (1:1)</option>
                            </select>
                        </div>
                        <div class="control-group">
                            <label>Detail Addition (if Addition)</label>
                            <input type="number" id="detailEfficiencyAddition" value="20" min="-50" max="50" step="5">
                        </div>
                        <div class="control-group">
                            <label>Detail Fixed % (if Fixed)</label>
                            <input type="number" id="detailEfficiencyFixed" value="80" min="0" max="100" step="5">
                        </div>
                    </div>
                    <div class="control-row">
                        <div class="control-group">
                            <label>New Bay Efficiency Source</label>
                            <select id="newBayEfficiencySource">
                                <option value="fixed" selected>Fixed Percentage</option>
                                <option value="percentOfCurrent">% of Current</option>
                                <option value="gradualRamp">Gradual Ramp</option>
                            </select>
                        </div>
                        <div class="control-group">
                            <label>New Bay % (if % of Current)</label>
                            <input type="number" id="newBayEfficiencyPercent" value="80" min="10" max="100" step="5">
                        </div>
                    </div>
                    
                    <h4 style="color: #495057; margin: 15px 0; border-bottom: 1px solid #dee2e6; padding-bottom: 5px;">Growth Calculations</h4>
                    <div class="control-row">
                        <div class="control-group">
                            <label>Used Car Growth Formula</label>
                            <select id="usedCarGrowthFormula">
                                <option value="fixed" selected>Fixed Percentage</option>
                                <option value="exponential">Exponential</option>
                            </select>
                        </div>
                        <div class="control-group">
                            <label>Exponential Base (if Exp)</label>
                            <input type="number" id="usedCarExponentialBase" value="1.15" min="1" max="2" step="0.05">
                        </div>
                    </div>
                    <div class="control-row">
                        <div class="control-group">
                            <label>Efficiency Growth Formula</label>
                            <select id="efficiencyGrowthFormula">
                                <option value="linear" selected>Linear</option>
                                <option value="exponential">Exponential</option>
                                <option value="sCurve">S-Curve</option>
                            </select>
                        </div>
                        <div class="control-group">
                            <label>Exponential Rate (if Exp)</label>
                            <input type="number" id="efficiencyExponentialRate" value="1.1" min="1" max="2" step="0.05">
                        </div>
                        <div class="control-group">
                            <label>S-Curve Midpoint Month</label>
                            <input type="number" id="efficiencySCurveMidpoint" value="6" min="1" max="12">
                        </div>
                    </div>
                    
                    <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 8px;">
                        <strong style="color: #495057;">Formula Preview:</strong>
                        <div id="formulaPreview" style="margin-top: 10px; font-family: monospace; color: #2a5298;"></div>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="button-row">
                <button class="btn" onclick="generateProjections()">Generate Projections</button>
                <button class="btn" onclick="exportToCSV()">Export CSV</button>
                <button class="btn" onclick="resetToDefaults()">Reset to Defaults</button>
                <button class="btn" onclick="saveConfiguration()">Save Config</button>
                <button class="btn" onclick="loadConfiguration()">Load Config</button>
            </div>
        </div>

        <div class="metrics-grid" id="metricsGrid">
            <!-- Metrics will be inserted here -->
        </div>

        <div class="bay-info" id="bayInfo">
            <!-- Bay scaling information will be shown here -->
        </div>

        <div class="summary-cards" id="summaryCards">
            <!-- Summary cards will be inserted here -->
        </div>

        <div class="table-wrapper">
            <table id="plTable">
                <!-- Table will be generated here -->
            </table>
        </div>
    </div>

    <script>
        // Comprehensive Configuration Object with all business parameters
        let config = {
            // Bay & Efficiency Configuration
            startingBays: 2,
            maxBays: 6,
            startingEfficiency: 40,
            growthRate: 20,
            bayTrigger: 100,
            newBayResetEfficiency: 50,
            maxRevenuePerBay: 20000,
            detailEfficiencyMultiplier: 1.2,
            
            // Service Configuration
            laborRate: 125,
            workingDays: 21,
            hoursPerTicket: 1.6,
            operatingHoursPerDay: 8,
            carsPerDayPerLift: 5,
            shopChargePercent: 7,
            shopChargeCap: 60,
            
            // Parts & Inventory Configuration
            partsMarkup: 40,
            serviceToPartsPercent: 70,
            initialTireInventory: 10000,
            monthlyTireInventory: 15000,
            
            // Revenue Stream Configuration
            detailMaxRevenue: 20000,
            initialUsedCars: 5,
            profitPerUsedCar: 3000,
            usedCarGrowthPercent: 15,
            firstMonthWarranties: 1,
            monthlyWarrantiesAfter: 4,
            warrantyPrice: 1000,
            oilDisposalFee: 150,
            generalDisposalFee: 200,
            batteryDisposalFee: 825,
            
            // Staff Salaries Configuration
            seniorTechAnnualSalary: 60000,
            juniorTechAnnualSalary: 45000,
            serviceAdvisorAnnualSalary: 70000,
            managerAnnualSalary: 100000,
            managerAnnualBonus: 10000,
            
            // Operating Expenses Configuration
            monthlyAdvertising: 1500,
            shopKeySoftwareMonthly: 300,
            paymentProcessingPercent: 2.29,
            paymentProcessingPerTransaction: 0.09,
            aaaAnnualMembership: 400,
            monthlyFuelCard: 400,
            monthlyUtilities: 1200,
            monthlySuretyBond: 20,
            monthlyGeneralLiability: 200,
            
            // Equipment Configuration
            laptopCostEach: 1500,
            desktopCostEach: 2000,
            numberOfDesktops: 2,
            scanToolCost: 2500,
            
            // Supplies & Disposal Configuration
            monthlyDetailSupplies: 500,
            monthlyShopSupplies: 1000,
            monthlyOilCostPerLift: 2500,
            wasteOilFiltersCost: 300,
            coolantDisposalCost: 300,
            wasteDisposalFrequencyMonths: 6,
            
            // Calculation Rules & Formulas Configuration
            // Revenue Calculation Rules
            partsGenerationFormula: 'percentOfService', // 'percentOfService' | 'fixedAmount' | 'perWorkOrder'
            partsGenerationModifier: 1.0,
            shopChargeFormula: 'minOfPercentOrCap', // 'minOfPercentOrCap' | 'percentOnly' | 'perOrderOnly'
            workOrderFormula: 'revenuePerTicket', // 'revenuePerTicket' | 'carsTimesEfficiency' | 'fixed'
            workOrdersFixed: 100, // Used if formula is 'fixed'
            
            // Cost Calculation Rules
            techSalaryFormula: 'seniorPlusJuniors', // 'seniorPlusJuniors' | 'allEqual' | 'perBay'
            techSalaryPerBay: 50000, // Annual salary per bay if 'perBay'
            oilCostFormula: 'perBay', // 'perBay' | 'percentOfRevenue' | 'perWorkOrder'
            oilCostPercent: 5, // If formula is 'percentOfRevenue'
            oilCostPerOrder: 50, // If formula is 'perWorkOrder'
            paymentProcessFormula: 'percentPlusTransaction', // 'percentPlusTransaction' | 'percentOnly' | 'flatRate'
            paymentProcessFlatRate: 1000, // If formula is 'flatRate'
            
            // Efficiency Calculation Rules
            detailEfficiencyLink: 'serviceEfficiency', // 'serviceEfficiency' | 'independent' | 'fixed'
            detailEfficiencyFormula: 'multiplier', // 'multiplier' | 'addition' | 'direct'
            detailEfficiencyAddition: 20, // If formula is 'addition'
            detailEfficiencyFixed: 80, // If link is 'fixed'
            newBayEfficiencySource: 'fixed', // 'fixed' | 'percentOfCurrent' | 'gradualRamp'
            newBayEfficiencyPercent: 80, // If source is 'percentOfCurrent'
            
            // Growth Calculation Rules
            usedCarGrowthFormula: 'fixed', // 'randomRange' | 'fixed' | 'exponential'
            usedCarFixedGrowth: 15, // If formula is 'fixed'
            usedCarExponentialBase: 1.15, // If formula is 'exponential'
            efficiencyGrowthFormula: 'linear', // 'linear' | 'exponential' | 'sCurve'
            efficiencyExponentialRate: 1.1, // If formula is 'exponential'
            efficiencySCurveMidpoint: 6 // Month where S-curve hits 50% if formula is 'sCurve'
        };

        // Calculate monthly projections
        function calculateMonthlyData() {
            const months = [];
            let currentBays = config.startingBays;
            let currentEfficiency = config.startingEfficiency;
            let techCount = config.startingBays; // Start with one tech per bay
            let bayEfficiencies = []; // Track individual bay efficiencies
            
            // Initialize bay efficiencies
            for (let i = 0; i < currentBays; i++) {
                bayEfficiencies.push(currentEfficiency);
            }
            
            for (let month = 0; month < 12; month++) {
                // First, apply growth to existing bays for the month
                if (month > 0) {
                    let totalDemand = 0;
                    let newEfficiencies = [];
                    
                    // Calculate what the new efficiency would be for each bay
                    for (let i = 0; i < bayEfficiencies.length; i++) {
                        let newEfficiency = bayEfficiencies[i];
                        if (config.efficiencyGrowthFormula === 'linear') {
                            newEfficiency = bayEfficiencies[i] * (1 + config.growthRate / 100);
                        } else if (config.efficiencyGrowthFormula === 'exponential') {
                            const baseEfficiency = config.startingEfficiency;
                            newEfficiency = baseEfficiency * Math.pow(config.efficiencyExponentialRate, month);
                        } else if (config.efficiencyGrowthFormula === 'sCurve') {
                            const maxEfficiency = 100;
                            const midpoint = config.efficiencySCurveMidpoint;
                            const steepness = 0.8;
                            newEfficiency = maxEfficiency / (1 + Math.exp(-steepness * (month - midpoint)));
                        }
                        newEfficiencies.push(newEfficiency);
                        totalDemand += newEfficiency;
                    }
                    
                    // Check if total demand exceeds capacity (100% per bay)
                    const maxCapacity = bayEfficiencies.length * 100;
                    if (totalDemand > maxCapacity && currentBays < config.maxBays) {
                        // Add a new bay to handle overflow
                        currentBays++;
                        techCount++;
                        const overflow = totalDemand - maxCapacity;
                        
                        // Existing bays stay at 100%
                        for (let i = 0; i < bayEfficiencies.length; i++) {
                            bayEfficiencies[i] = Math.min(newEfficiencies[i], 100);
                        }
                        
                        // New bay gets the overflow demand
                        bayEfficiencies.push(overflow);
                    } else {
                        // No new bay needed, just update efficiencies (capped at 100%)
                        for (let i = 0; i < bayEfficiencies.length; i++) {
                            bayEfficiencies[i] = Math.min(newEfficiencies[i], 100);
                        }
                    }
                }
                
                // Calculate service revenue based on individual bay efficiencies
                let serviceRevenue = 0;
                bayEfficiencies.forEach(efficiency => {
                    serviceRevenue += config.maxRevenuePerBay * (efficiency / 100);
                });
                currentEfficiency = bayEfficiencies.reduce((sum, eff) => sum + eff, 0) / bayEfficiencies.length;
                
                // Calculate parts revenue based on configured formula
                let partsCost, partsRevenue;
                if (config.partsGenerationFormula === 'percentOfService') {
                    partsCost = serviceRevenue * (config.serviceToPartsPercent / 100) / (1 + config.partsMarkup / 100);
                    partsRevenue = partsCost * (1 + config.partsMarkup / 100) * config.partsGenerationModifier;
                } else if (config.partsGenerationFormula === 'fixedAmount') {
                    partsCost = 5000 * currentBays * config.partsGenerationModifier; // Base $5k per bay
                    partsRevenue = partsCost * (1 + config.partsMarkup / 100);
                } else if (config.partsGenerationFormula === 'perWorkOrder') {
                    const tempWorkOrders = Math.floor(serviceRevenue / (config.hoursPerTicket * config.laborRate));
                    partsCost = tempWorkOrders * 200 * config.partsGenerationModifier; // $200 parts per order
                    partsRevenue = partsCost * (1 + config.partsMarkup / 100);
                }
                
                // Calculate work orders based on configured formula
                const avgTicketValue = (config.hoursPerTicket * config.laborRate);
                let workOrders;
                if (config.workOrderFormula === 'revenuePerTicket') {
                    workOrders = Math.floor(serviceRevenue / avgTicketValue);
                } else if (config.workOrderFormula === 'carsTimesEfficiency') {
                    workOrders = Math.floor(config.carsPerDayPerLift * config.workingDays * currentBays * (currentEfficiency / 100));
                } else if (config.workOrderFormula === 'fixed') {
                    workOrders = config.workOrdersFixed;
                }
                
                // Calculate shop charge based on configured formula
                let shopCharge;
                if (config.shopChargeFormula === 'minOfPercentOrCap') {
                    shopCharge = Math.min(workOrders * config.shopChargeCap, serviceRevenue * (config.shopChargePercent / 100));
                } else if (config.shopChargeFormula === 'percentOnly') {
                    shopCharge = serviceRevenue * (config.shopChargePercent / 100);
                } else if (config.shopChargeFormula === 'perOrderOnly') {
                    shopCharge = workOrders * config.shopChargeCap;
                }
                
                // Warranty revenue using config
                const warrantyRevenue = month === 0 ? 
                    config.firstMonthWarranties * config.warrantyPrice : 
                    config.monthlyWarrantiesAfter * config.warrantyPrice;
                
                // Used car sales based on configured growth formula
                const initialUsedCarRevenue = config.initialUsedCars * config.profitPerUsedCar;
                const carSalesBase = month === 0 ? initialUsedCarRevenue : months[month - 1].usedCarSales;
                let usedCarSales;
                if (config.usedCarGrowthFormula === 'randomRange' || config.usedCarGrowthFormula === 'fixed') {
                    // Use the single growth rate for both random and fixed
                    usedCarSales = carSalesBase * (1 + config.usedCarGrowthPercent / 100);
                } else if (config.usedCarGrowthFormula === 'exponential') {
                    usedCarSales = initialUsedCarRevenue * Math.pow(config.usedCarExponentialBase, month);
                }
                
                // Detail department efficiency and revenue based on configured formula
                let detailEfficiency;
                if (config.detailEfficiencyLink === 'serviceEfficiency') {
                    if (config.detailEfficiencyFormula === 'multiplier') {
                        detailEfficiency = Math.min(currentEfficiency * config.detailEfficiencyMultiplier, 100);
                    } else if (config.detailEfficiencyFormula === 'addition') {
                        detailEfficiency = Math.min(currentEfficiency + config.detailEfficiencyAddition, 100);
                    } else if (config.detailEfficiencyFormula === 'direct') {
                        detailEfficiency = currentEfficiency;
                    }
                } else if (config.detailEfficiencyLink === 'independent') {
                    detailEfficiency = Math.min(40 * (1 + month * 0.1), 100); // Independent growth
                } else if (config.detailEfficiencyLink === 'fixed') {
                    detailEfficiency = config.detailEfficiencyFixed;
                }
                const detailRevenue = config.detailMaxRevenue * (detailEfficiency / 100);
                
                // Calculate tech salaries based on configured formula
                let techSalaries;
                if (config.techSalaryFormula === 'seniorPlusJuniors') {
                    techSalaries = (config.seniorTechAnnualSalary / 12) + ((techCount - 1) * config.juniorTechAnnualSalary / 12);
                } else if (config.techSalaryFormula === 'allEqual') {
                    techSalaries = techCount * (config.juniorTechAnnualSalary / 12);
                } else if (config.techSalaryFormula === 'perBay') {
                    techSalaries = currentBays * (config.techSalaryPerBay / 12);
                }
                const advisorSalary = config.serviceAdvisorAnnualSalary / 12;
                const managerSalary = config.managerAnnualSalary / 12 + (month === 11 ? config.managerAnnualBonus : 0);
                
                // Calculate oil costs based on configured formula
                let oilCosts;
                if (config.oilCostFormula === 'perBay') {
                    oilCosts = currentBays * config.monthlyOilCostPerLift;
                } else if (config.oilCostFormula === 'percentOfRevenue') {
                    oilCosts = serviceRevenue * (config.oilCostPercent / 100);
                } else if (config.oilCostFormula === 'perWorkOrder') {
                    oilCosts = workOrders * config.oilCostPerOrder;
                }
                
                // Payment processing based on configured formula
                const totalRevenue = serviceRevenue + partsRevenue + shopCharge + warrantyRevenue + 
                                   usedCarSales + detailRevenue + config.oilDisposalFee + 
                                   config.generalDisposalFee + config.batteryDisposalFee;
                let paymentProcessing;
                if (config.paymentProcessFormula === 'percentPlusTransaction') {
                    paymentProcessing = (totalRevenue * config.paymentProcessingPercent / 100) + 
                                       (workOrders * config.paymentProcessingPerTransaction);
                } else if (config.paymentProcessFormula === 'percentOnly') {
                    paymentProcessing = totalRevenue * config.paymentProcessingPercent / 100;
                } else if (config.paymentProcessFormula === 'flatRate') {
                    paymentProcessing = config.paymentProcessFlatRate;
                }
                
                months.push({
                    month: month + 1,
                    bays: currentBays,
                    efficiency: currentEfficiency,
                    techCount: techCount,
                    // Revenue
                    serviceRevenue: serviceRevenue,
                    partsRevenue: partsRevenue,
                    shopCharge: shopCharge,
                    warrantyRevenue: warrantyRevenue,
                    oilDisposal: config.oilDisposalFee,
                    disposalFees: config.generalDisposalFee,
                    batteryDisposal: config.batteryDisposalFee,
                    usedCarSales: usedCarSales,
                    detailRevenue: detailRevenue,
                    // Expenses
                    partsCost: partsCost,
                    techSalaries: techSalaries,
                    advisorSalary: advisorSalary,
                    managerSalary: managerSalary,
                    advertising: config.monthlyAdvertising,
                    shopKey: config.shopKeySoftwareMonthly,
                    aaaSignup: config.aaaAnnualMembership / 12,
                    fuelCard: config.monthlyFuelCard,
                    utilities: config.monthlyUtilities,
                    scanTool: month === 0 ? config.scanToolCost : 0,
                    wasteOilFilters: month % config.wasteDisposalFrequencyMonths === 0 ? config.wasteOilFiltersCost : 0,
                    coolantDisposal: month % config.wasteDisposalFrequencyMonths === 0 ? config.coolantDisposalCost : 0,
                    tireInventory: month === 0 ? config.initialTireInventory : config.monthlyTireInventory,
                    oilCosts: oilCosts,
                    detailSupplies: config.monthlyDetailSupplies,
                    shopSupplies: config.monthlyShopSupplies,
                    suretyBond: config.monthlySuretyBond,
                    liability: config.monthlyGeneralLiability,
                    paymentProcessing: paymentProcessing,
                    laptops: month === 0 ? techCount * config.laptopCostEach : 
                            (currentBays > months[month-1].bays ? config.laptopCostEach : 0),
                    desktops: month === 0 ? config.desktopCostEach * config.numberOfDesktops : 0,
                    workOrders: workOrders
                });
                
                // Efficiency growth is now handled at the beginning of each month's loop
            }
            
            return months;
        }

        function formatCurrency(value) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(value);
        }

        function updateMetrics(data) {
            const metricsGrid = document.getElementById('metricsGrid');
            const lastMonth = data[11];
            
            metricsGrid.innerHTML = `
                <div class="metric-card">
                    <h4>Active Bays (Month 12)</h4>
                    <div class="value">${lastMonth.bays}</div>
                </div>
                <div class="metric-card">
                    <h4>Efficiency (Month 12)</h4>
                    <div class="value">${lastMonth.efficiency.toFixed(1)}%</div>
                    <div class="efficiency-bar">
                        <div class="efficiency-fill" style="width: ${lastMonth.efficiency}%">
                            ${lastMonth.efficiency.toFixed(0)}%
                        </div>
                    </div>
                </div>
                <div class="metric-card">
                    <h4>Tech Count (Month 12)</h4>
                    <div class="value">${lastMonth.techCount}</div>
                </div>
                <div class="metric-card">
                    <h4>Monthly Work Orders</h4>
                    <div class="value">${lastMonth.workOrders}</div>
                </div>
                <div class="metric-card">
                    <h4>Avg Ticket Value</h4>
                    <div class="value">${formatCurrency(config.hoursPerTicket * config.laborRate)}</div>
                </div>
                <div class="metric-card">
                    <h4>Cars per Day (Month 12)</h4>
                    <div class="value">${(lastMonth.workOrders / config.workingDays).toFixed(1)}</div>
                </div>
            `;
        }

        function updateBayInfo(data) {
            const bayInfo = document.getElementById('bayInfo');
            let bayChanges = [];
            
            for (let i = 1; i < data.length; i++) {
                if (data[i].bays > data[i-1].bays) {
                    const prevAvgEfficiency = data[i-1].efficiency.toFixed(1);
                    const newBayEfficiency = ((data[i].efficiency * data[i].bays) - (100 * (data[i].bays - 1))).toFixed(1);
                    bayChanges.push(`Month ${i + 1}: Added Bay #${data[i].bays} (Overflow demand: ${newBayEfficiency}% goes to new bay)`);
                }
            }
            
            if (bayChanges.length > 0) {
                bayInfo.innerHTML = `<strong>Bay Scaling Events:</strong> ${bayChanges.join(' | ')}`;
                if (data[11].bays >= config.maxBays) {
                    bayInfo.innerHTML += ` | <strong>Max capacity reached (${config.maxBays} bays)</strong>`;
                }
            } else {
                bayInfo.innerHTML = `<strong>Note:</strong> No additional bays added during projection period. Final average efficiency: ${data[11].efficiency.toFixed(1)}% with ${data[11].bays} bay(s) (Max: ${config.maxBays}).`;
            }
        }

        function generateTable(data) {
            const table = document.getElementById('plTable');
            table.innerHTML = '';
            
            // Header
            let headerRow = '<tr><th>Category</th>';
            for (let i = 0; i < 12; i++) {
                headerRow += `<th>Month ${i + 1}</th>`;
            }
            headerRow += '<th>Total</th></tr>';
            table.innerHTML = headerRow;
            
            // REVENUE SECTION
            table.innerHTML += '<tr class="category-header"><td colspan="14">REVENUE</td></tr>';
            
            // Service Revenue
            let row = '<tr class="subcategory"><td>Service Labor Revenue</td>';
            let total = 0;
            data.forEach(m => {
                row += `<td>${formatCurrency(m.serviceRevenue)}</td>`;
                total += m.serviceRevenue;
            });
            row += `<td>${formatCurrency(total)}</td></tr>`;
            table.innerHTML += row;
            
            // Parts Revenue
            row = '<tr class="subcategory"><td>Parts Revenue (40% markup)</td>';
            total = 0;
            data.forEach(m => {
                row += `<td>${formatCurrency(m.partsRevenue)}</td>`;
                total += m.partsRevenue;
            });
            row += `<td>${formatCurrency(total)}</td></tr>`;
            table.innerHTML += row;
            
            // Detail Department
            row = '<tr class="subcategory"><td>Detail Department</td>';
            total = 0;
            data.forEach(m => {
                row += `<td>${formatCurrency(m.detailRevenue)}</td>`;
                total += m.detailRevenue;
            });
            row += `<td>${formatCurrency(total)}</td></tr>`;
            table.innerHTML += row;
            
            // Used Car Sales
            row = '<tr class="subcategory"><td>Used Car Sales</td>';
            total = 0;
            data.forEach(m => {
                row += `<td>${formatCurrency(m.usedCarSales)}</td>`;
                total += m.usedCarSales;
            });
            row += `<td>${formatCurrency(total)}</td></tr>`;
            table.innerHTML += row;
            
            // Shop Charges & Fees
            row = '<tr class="subcategory"><td>Shop Charge (7% capped $60)</td>';
            total = 0;
            data.forEach(m => {
                row += `<td>${formatCurrency(m.shopCharge)}</td>`;
                total += m.shopCharge;
            });
            row += `<td>${formatCurrency(total)}</td></tr>`;
            table.innerHTML += row;
            
            // Warranty Revenue
            row = '<tr class="subcategory"><td>Extended Warranties</td>';
            total = 0;
            data.forEach(m => {
                row += `<td>${formatCurrency(m.warrantyRevenue)}</td>`;
                total += m.warrantyRevenue;
            });
            row += `<td>${formatCurrency(total)}</td></tr>`;
            table.innerHTML += row;
            
            // Disposal Fees Income
            const disposalItems = [
                { key: 'oilDisposal', label: 'Oil Disposal' },
                { key: 'disposalFees', label: 'Disposal Fees' },
                { key: 'batteryDisposal', label: 'Battery Disposal' }
            ];
            
            disposalItems.forEach(item => {
                row = `<tr class="subcategory"><td>${item.label}</td>`;
                total = 0;
                data.forEach(m => {
                    row += `<td>${formatCurrency(m[item.key])}</td>`;
                    total += m[item.key];
                });
                row += `<td>${formatCurrency(total)}</td></tr>`;
                table.innerHTML += row;
            });
            
            // Total Revenue
            row = '<tr class="total-row"><td>Total Revenue</td>';
            let grandTotalRevenue = 0;
            data.forEach(m => {
                const monthTotal = m.serviceRevenue + m.partsRevenue + m.detailRevenue + m.usedCarSales + 
                                 m.shopCharge + m.warrantyRevenue + m.oilDisposal + m.disposalFees + m.batteryDisposal;
                row += `<td>${formatCurrency(monthTotal)}</td>`;
                grandTotalRevenue += monthTotal;
            });
            row += `<td>${formatCurrency(grandTotalRevenue)}</td></tr>`;
            table.innerHTML += row;
            
            // EXPENSES SECTION
            table.innerHTML += '<tr class="category-header"><td colspan="14">EXPENSES</td></tr>';
            
            // Cost of Goods Sold
            table.innerHTML += '<tr class="subcategory"><td><strong>Cost of Goods Sold</strong></td><td colspan="13"></td></tr>';
            
            row = '<tr class="subcategory"><td>Parts Cost (70% of service)</td>';
            total = 0;
            data.forEach(m => {
                row += `<td>${formatCurrency(m.partsCost)}</td>`;
                total += m.partsCost;
            });
            row += `<td>${formatCurrency(total)}</td></tr>`;
            table.innerHTML += row;
            
            row = '<tr class="subcategory"><td>Tire Inventory</td>';
            total = 0;
            data.forEach(m => {
                row += `<td>${formatCurrency(m.tireInventory)}</td>`;
                total += m.tireInventory;
            });
            row += `<td>${formatCurrency(total)}</td></tr>`;
            table.innerHTML += row;
            
            row = '<tr class="subcategory"><td>Oil Costs (Per Bay)</td>';
            total = 0;
            data.forEach(m => {
                row += `<td>${formatCurrency(m.oilCosts)}</td>`;
                total += m.oilCosts;
            });
            row += `<td>${formatCurrency(total)}</td></tr>`;
            table.innerHTML += row;
            
            // Labor Costs
            table.innerHTML += '<tr class="subcategory"><td><strong>Labor Costs</strong></td><td colspan="13"></td></tr>';
            
            row = '<tr class="subcategory"><td>Technician Salaries</td>';
            total = 0;
            data.forEach(m => {
                row += `<td>${formatCurrency(m.techSalaries)}</td>`;
                total += m.techSalaries;
            });
            row += `<td>${formatCurrency(total)}</td></tr>`;
            table.innerHTML += row;
            
            row = '<tr class="subcategory"><td>Service Advisor (Nick)</td>';
            total = 0;
            data.forEach(m => {
                row += `<td>${formatCurrency(m.advisorSalary)}</td>`;
                total += m.advisorSalary;
            });
            row += `<td>${formatCurrency(total)}</td></tr>`;
            table.innerHTML += row;
            
            row = '<tr class="subcategory"><td>Manager (Josh) + Bonus</td>';
            total = 0;
            data.forEach(m => {
                row += `<td>${formatCurrency(m.managerSalary)}</td>`;
                total += m.managerSalary;
            });
            row += `<td>${formatCurrency(total)}</td></tr>`;
            table.innerHTML += row;
            
            // Operating Expenses
            table.innerHTML += '<tr class="subcategory"><td><strong>Operating Expenses</strong></td><td colspan="13"></td></tr>';
            
            const operatingExpenses = [
                { key: 'advertising', label: 'Advertising' },
                { key: 'utilities', label: 'Utilities' },
                { key: 'shopKey', label: 'ShopKey Software' },
                { key: 'paymentProcessing', label: 'Payment Processing (2.29%)' },
                { key: 'fuelCard', label: 'Fuel Card' },
                { key: 'detailSupplies', label: 'Detail Supplies' },
                { key: 'shopSupplies', label: 'Shop Supplies/Misc' },
                { key: 'suretyBond', label: 'Surety Bond' },
                { key: 'liability', label: 'General Liability Insurance' },
                { key: 'aaaSignup', label: 'AAA Signup (Annual)' }
            ];
            
            operatingExpenses.forEach(expense => {
                row = `<tr class="subcategory"><td>${expense.label}</td>`;
                total = 0;
                data.forEach(m => {
                    row += `<td>${formatCurrency(m[expense.key])}</td>`;
                    total += m[expense.key];
                });
                row += `<td>${formatCurrency(total)}</td></tr>`;
                table.innerHTML += row;
            });
            
            // One-time/Periodic Expenses
            table.innerHTML += '<tr class="subcategory"><td><strong>Equipment & Periodic</strong></td><td colspan="13"></td></tr>';
            
            row = '<tr class="subcategory"><td>Scan Tool (One-time)</td>';
            total = 0;
            data.forEach(m => {
                row += `<td>${formatCurrency(m.scanTool)}</td>`;
                total += m.scanTool;
            });
            row += `<td>${formatCurrency(total)}</td></tr>`;
            table.innerHTML += row;
            
            row = '<tr class="subcategory"><td>Tech Laptops</td>';
            total = 0;
            data.forEach(m => {
                row += `<td>${formatCurrency(m.laptops)}</td>`;
                total += m.laptops;
            });
            row += `<td>${formatCurrency(total)}</td></tr>`;
            table.innerHTML += row;
            
            row = '<tr class="subcategory"><td>Desktop Computers</td>';
            total = 0;
            data.forEach(m => {
                row += `<td>${formatCurrency(m.desktops)}</td>`;
                total += m.desktops;
            });
            row += `<td>${formatCurrency(total)}</td></tr>`;
            table.innerHTML += row;
            
            row = '<tr class="subcategory"><td>Waste Oil Filters (6mo)</td>';
            total = 0;
            data.forEach(m => {
                row += `<td>${formatCurrency(m.wasteOilFilters)}</td>`;
                total += m.wasteOilFilters;
            });
            row += `<td>${formatCurrency(total)}</td></tr>`;
            table.innerHTML += row;
            
            row = '<tr class="subcategory"><td>Coolant Disposal (6mo)</td>';
            total = 0;
            data.forEach(m => {
                row += `<td>${formatCurrency(m.coolantDisposal)}</td>`;
                total += m.coolantDisposal;
            });
            row += `<td>${formatCurrency(total)}</td></tr>`;
            table.innerHTML += row;
            
            // Total Expenses
            row = '<tr class="expense-total"><td>Total Expenses</td>';
            let grandTotalExpenses = 0;
            data.forEach(m => {
                const monthExpenses = m.partsCost + m.tireInventory + m.oilCosts + m.techSalaries + m.advisorSalary + 
                                    m.managerSalary + m.advertising + m.utilities + m.shopKey + 
                                    m.paymentProcessing + m.fuelCard + m.detailSupplies + m.shopSupplies + 
                                    m.suretyBond + m.liability + m.aaaSignup + m.scanTool + m.laptops + 
                                    m.desktops + m.wasteOilFilters + m.coolantDisposal;
                row += `<td>${formatCurrency(monthExpenses)}</td>`;
                grandTotalExpenses += monthExpenses;
            });
            row += `<td>${formatCurrency(grandTotalExpenses)}</td></tr>`;
            table.innerHTML += row;
            
            // Net Income
            row = '<tr class="net-income"><td>NET INCOME</td>';
            let totalNetIncome = 0;
            data.forEach(m => {
                const monthRevenue = m.serviceRevenue + m.partsRevenue + m.detailRevenue + m.usedCarSales + 
                                   m.shopCharge + m.warrantyRevenue + m.oilDisposal + m.disposalFees + m.batteryDisposal;
                const monthExpenses = m.partsCost + m.tireInventory + m.oilCosts + m.techSalaries + m.advisorSalary + 
                                    m.managerSalary + m.advertising + m.utilities + m.shopKey + 
                                    m.paymentProcessing + m.fuelCard + m.detailSupplies + m.shopSupplies + 
                                    m.suretyBond + m.liability + m.aaaSignup + m.scanTool + m.laptops + 
                                    m.desktops + m.wasteOilFilters + m.coolantDisposal;
                const netIncome = monthRevenue - monthExpenses;
                totalNetIncome += netIncome;
                const className = netIncome >= 0 ? 'positive' : 'negative';
                row += `<td class="${className}">${formatCurrency(netIncome)}</td>`;
            });
            const totalClassName = totalNetIncome >= 0 ? 'positive' : 'negative';
            row += `<td class="${totalClassName}">${formatCurrency(totalNetIncome)}</td></tr>`;
            table.innerHTML += row;
            
            // Update summary cards
            updateSummaryCards(grandTotalRevenue, grandTotalExpenses, totalNetIncome);
        }

        function updateSummaryCards(revenue, expenses, netIncome) {
            const summaryCards = document.getElementById('summaryCards');
            const margin = revenue > 0 ? (netIncome / revenue * 100).toFixed(1) : 0;
            const avgMonthlyIncome = netIncome / 12;
            
            summaryCards.innerHTML = `
                <div class="summary-card">
                    <h3>Total Revenue</h3>
                    <div class="value">${formatCurrency(revenue)}</div>
                </div>
                <div class="summary-card">
                    <h3>Total Expenses</h3>
                    <div class="value">${formatCurrency(expenses)}</div>
                </div>
                <div class="summary-card ${netIncome >= 0 ? 'profit' : 'loss'}">
                    <h3>Net Income</h3>
                    <div class="value">${formatCurrency(netIncome)}</div>
                </div>
                <div class="summary-card">
                    <h3>Profit Margin</h3>
                    <div class="value">${margin}%</div>
                </div>
                <div class="summary-card">
                    <h3>Avg Monthly Income</h3>
                    <div class="value">${formatCurrency(avgMonthlyIncome)}</div>
                </div>
            `;
        }

        function generateProjections() {
            // Update all config values from inputs and selects
            const inputs = document.querySelectorAll('.control-group input, .control-group select');
            inputs.forEach(input => {
                const key = input.id;
                if (config.hasOwnProperty(key)) {
                    if (input.tagName === 'SELECT') {
                        config[key] = input.value;
                    } else {
                        const value = input.type === 'number' ? 
                            (input.step && input.step.includes('.') ? parseFloat(input.value) : parseInt(input.value)) : 
                            input.value;
                        config[key] = value;
                    }
                }
            });
            
            // Update formula preview
            updateFormulaPreview();
            
            // Generate data and update display
            const data = calculateMonthlyData();
            updateMetrics(data);
            updateBayInfo(data);
            generateTable(data);
        }
        
        // Toggle section collapse/expand
        window.toggleSection = function(sectionId) {
            const section = document.getElementById(sectionId);
            if (section) {
                section.classList.toggle('collapsed');
            } else {
                console.error('Section not found:', sectionId);
            }
        }
        
        // Reset all configuration to defaults
        function resetToDefaults() {
            const inputs = document.querySelectorAll('.control-group input');
            inputs.forEach(input => {
                const defaultValue = input.getAttribute('value');
                if (defaultValue) {
                    input.value = defaultValue;
                }
            });
            generateProjections();
        }
        
        // Save configuration to JSON
        function saveConfiguration() {
            const configJSON = JSON.stringify(config, null, 2);
            const blob = new Blob([configJSON], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'autoshop-config.json';
            a.click();
            window.URL.revokeObjectURL(url);
        }
        
        // Load configuration from file
        function loadConfiguration() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            const loadedConfig = JSON.parse(event.target.result);
                            // Update config and UI
                            Object.keys(loadedConfig).forEach(key => {
                                if (config.hasOwnProperty(key)) {
                                    config[key] = loadedConfig[key];
                                    const input = document.getElementById(key);
                                    if (input) {
                                        input.value = loadedConfig[key];
                                    }
                                }
                            });
                            generateProjections();
                        } catch (err) {
                            alert('Error loading configuration file: ' + err.message);
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        function exportToCSV() {
            const data = calculateMonthlyData();
            let csv = 'Auto Repair Shop P&L Projection\n\n';
            
            // Configuration summary
            csv += 'Configuration\n';
            csv += `Starting Bays,${config.startingBays}\n`;
            csv += `Starting Efficiency,${config.startingEfficiency}%\n`;
            csv += `Monthly Growth Rate,${config.growthRate}%\n`;
            csv += `Bay Trigger,${config.bayTrigger}%\n`;
            csv += `Labor Rate,${config.laborRate}/hr\n`;
            csv += `Working Days,${config.workingDays}\n\n`;
            
            // Header row
            csv += 'Category';
            for (let i = 1; i <= 12; i++) {
                csv += `,Month ${i}`;
            }
            csv += ',Total\n';
            
            // Bay and Efficiency info
            csv += 'Active Bays';
            data.forEach(m => csv += `,${m.bays}`);
            csv += '\n';
            
            csv += 'Efficiency %';
            data.forEach(m => csv += `,${m.efficiency.toFixed(1)}`);
            csv += '\n\n';
            
            // Revenue items
            csv += 'REVENUE\n';
            const revenueItems = [
                { key: 'serviceRevenue', label: 'Service Labor Revenue' },
                { key: 'partsRevenue', label: 'Parts Revenue' },
                { key: 'detailRevenue', label: 'Detail Department' },
                { key: 'usedCarSales', label: 'Used Car Sales' },
                { key: 'shopCharge', label: 'Shop Charge' },
                { key: 'warrantyRevenue', label: 'Extended Warranties' },
                { key: 'oilDisposal', label: 'Oil Disposal' },
                { key: 'disposalFees', label: 'Disposal Fees' },
                { key: 'batteryDisposal', label: 'Battery Disposal' }
            ];
            
            revenueItems.forEach(item => {
                csv += item.label;
                let total = 0;
                data.forEach(m => {
                    csv += `,${m[item.key]}`;
                    total += m[item.key];
                });
                csv += `,${total}\n`;
            });
            
            // Total Revenue
            csv += 'Total Revenue';
            let grandTotalRevenue = 0;
            data.forEach(m => {
                const monthTotal = m.serviceRevenue + m.partsRevenue + m.detailRevenue + m.usedCarSales + 
                                 m.shopCharge + m.warrantyRevenue + m.oilDisposal + m.disposalFees + m.batteryDisposal;
                csv += `,${monthTotal}`;
                grandTotalRevenue += monthTotal;
            });
            csv += `,${grandTotalRevenue}\n\n`;
            
            // Expenses
            csv += 'EXPENSES\n';
            const expenseItems = [
                { key: 'partsCost', label: 'Parts Cost' },
                { key: 'tireInventory', label: 'Tire Inventory' },
                { key: 'oilCosts', label: 'Oil Costs (Per Bay)' },
                { key: 'techSalaries', label: 'Technician Salaries' },
                { key: 'advisorSalary', label: 'Service Advisor' },
                { key: 'managerSalary', label: 'Manager + Bonus' },
                { key: 'advertising', label: 'Advertising' },
                { key: 'utilities', label: 'Utilities' },
                { key: 'shopKey', label: 'ShopKey Software' },
                { key: 'paymentProcessing', label: 'Payment Processing' },
                { key: 'fuelCard', label: 'Fuel Card' },
                { key: 'detailSupplies', label: 'Detail Supplies' },
                { key: 'shopSupplies', label: 'Shop Supplies' },
                { key: 'suretyBond', label: 'Surety Bond' },
                { key: 'liability', label: 'General Liability' },
                { key: 'aaaSignup', label: 'AAA Signup' },
                { key: 'scanTool', label: 'Scan Tool' },
                { key: 'laptops', label: 'Tech Laptops' },
                { key: 'desktops', label: 'Desktop Computers' },
                { key: 'wasteOilFilters', label: 'Waste Oil Filters' },
                { key: 'coolantDisposal', label: 'Coolant Disposal' }
            ];
            
            expenseItems.forEach(item => {
                csv += item.label;
                let total = 0;
                data.forEach(m => {
                    csv += `,${m[item.key]}`;
                    total += m[item.key];
                });
                csv += `,${total}\n`;
            });
            
            // Total Expenses
            csv += 'Total Expenses';
            let grandTotalExpenses = 0;
            data.forEach(m => {
                const monthExpenses = m.partsCost + m.tireInventory + m.oilCosts + m.techSalaries + m.advisorSalary + 
                                    m.managerSalary + m.advertising + m.utilities + m.shopKey + 
                                    m.paymentProcessing + m.fuelCard + m.detailSupplies + m.shopSupplies + 
                                    m.suretyBond + m.liability + m.aaaSignup + m.scanTool + m.laptops + 
                                    m.desktops + m.wasteOilFilters + m.coolantDisposal;
                csv += `,${monthExpenses}`;
                grandTotalExpenses += monthExpenses;
            });
            csv += `,${grandTotalExpenses}\n\n`;
            
            // Net Income
            csv += 'NET INCOME';
            let totalNetIncome = 0;
            data.forEach(m => {
                const monthRevenue = m.serviceRevenue + m.partsRevenue + m.detailRevenue + m.usedCarSales + 
                                   m.shopCharge + m.warrantyRevenue + m.oilDisposal + m.disposalFees + m.batteryDisposal;
                const monthExpenses = m.partsCost + m.tireInventory + m.oilCosts + m.techSalaries + m.advisorSalary + 
                                    m.managerSalary + m.advertising + m.utilities + m.shopKey + 
                                    m.paymentProcessing + m.fuelCard + m.detailSupplies + m.shopSupplies + 
                                    m.suretyBond + m.liability + m.aaaSignup + m.scanTool + m.laptops + 
                                    m.desktops + m.wasteOilFilters + m.coolantDisposal;
                const netIncome = monthRevenue - monthExpenses;
                csv += `,${netIncome}`;
                totalNetIncome += netIncome;
            });
            csv += `,${totalNetIncome}\n`;
            
            // Download
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'auto_repair_pl_projection.csv';
            a.click();
            window.URL.revokeObjectURL(url);
        }
        
        // Update formula preview display
        function updateFormulaPreview() {
            const preview = document.getElementById('formulaPreview');
            if (!preview) return;
            
            let formulas = [];
            
            // Parts generation formula
            if (config.partsGenerationFormula === 'percentOfService') {
                formulas.push(`Parts Cost = Service Revenue × ${config.serviceToPartsPercent}% × Modifier(${config.partsGenerationModifier})`);
            } else if (config.partsGenerationFormula === 'fixedAmount') {
                formulas.push(`Parts Cost = $5,000 × Bays × Modifier(${config.partsGenerationModifier})`);
            } else if (config.partsGenerationFormula === 'perWorkOrder') {
                formulas.push(`Parts Cost = Work Orders × $200 × Modifier(${config.partsGenerationModifier})`);
            }
            
            // Work order formula
            if (config.workOrderFormula === 'revenuePerTicket') {
                formulas.push(`Work Orders = Service Revenue ÷ ($${config.laborRate} × ${config.hoursPerTicket} hrs)`);
            } else if (config.workOrderFormula === 'carsTimesEfficiency') {
                formulas.push(`Work Orders = ${config.carsPerDayPerLift} cars/day × ${config.workingDays} days × Bays × Efficiency`);
            } else if (config.workOrderFormula === 'fixed') {
                formulas.push(`Work Orders = ${config.workOrdersFixed} (fixed)`);
            }
            
            // Oil cost formula
            if (config.oilCostFormula === 'perBay') {
                formulas.push(`Oil Costs = Bays × $${config.monthlyOilCostPerLift}`);
            } else if (config.oilCostFormula === 'percentOfRevenue') {
                formulas.push(`Oil Costs = Service Revenue × ${config.oilCostPercent}%`);
            } else if (config.oilCostFormula === 'perWorkOrder') {
                formulas.push(`Oil Costs = Work Orders × $${config.oilCostPerOrder}`);
            }
            
            // Detail efficiency formula
            if (config.detailEfficiencyLink === 'serviceEfficiency') {
                if (config.detailEfficiencyFormula === 'multiplier') {
                    formulas.push(`Detail Efficiency = Service Efficiency × ${config.detailEfficiencyMultiplier}`);
                } else if (config.detailEfficiencyFormula === 'addition') {
                    formulas.push(`Detail Efficiency = Service Efficiency + ${config.detailEfficiencyAddition}%`);
                } else if (config.detailEfficiencyFormula === 'direct') {
                    formulas.push(`Detail Efficiency = Service Efficiency (1:1)`);
                }
            } else if (config.detailEfficiencyLink === 'fixed') {
                formulas.push(`Detail Efficiency = ${config.detailEfficiencyFixed}% (fixed)`);
            }
            
            preview.innerHTML = formulas.join('<br>');
        }
        
        // Add event listeners for formula selects
        document.addEventListener('DOMContentLoaded', function() {
            // Add change listeners to all calculation rule selects
            const calculationSelects = document.querySelectorAll('#calculationSection select');
            calculationSelects.forEach(select => {
                select.addEventListener('change', function() {
                    config[this.id] = this.value;
                    updateFormulaPreview();
                });
            });
            
            // Add change listeners to related inputs
            const calculationInputs = document.querySelectorAll('#calculationSection input');
            calculationInputs.forEach(input => {
                input.addEventListener('input', function() {
                    const value = this.type === 'number' ? 
                        (this.step && this.step.includes('.') ? parseFloat(this.value) : parseInt(this.value)) : 
                        this.value;
                    config[this.id] = value;
                    updateFormulaPreview();
                });
            });
        });

        // Initialize on load
        generateProjections();
    </script>
</body>
</html>